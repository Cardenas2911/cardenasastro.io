---
import Layout from "../../layouts/Layout.astro";
import ProfileCard from "../../components/ProfileCard.astro";
---

<Layout
    title="Test de Salud SEO Gratis en Colombia: Diagn√≥stico Web en 2 Minutos"
    description="¬øTu web no aparece en Google? Realiza el Test de Salud SEO gratuito y obt√©n un diagn√≥stico t√©cnico de tu sitio. Mejora tu visibilidad y atrae clientes en Colombia."
    ogTitle="üöÄ ¬øQu√© tan 'sana' est√° tu p√°gina web? Desc√∫brelo con este Test."
    ogDescription="Eval√∫a tu SEO t√©cnico, contenido y autoridad con este quiz interactivo dise√±ado para empresas en Colombia. Recibe tu diagn√≥stico al instante."
    showGlobalBanner={false}
>
    <!-- Background Decor -->
    <div class="fixed inset-0 pointer-events-none z-[-1] overflow-hidden">
        <div
            class="absolute top-0 right-0 w-[500px] h-[500px] bg-gold/5 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/2"
        >
        </div>
        <div
            class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-neutral-900/10 dark:bg-neutral-800/20 rounded-full blur-[120px] translate-y-1/2 -translate-x-1/2"
        >
        </div>
    </div>

    <div
        class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-8 py-8 md:py-12 max-w-7xl mx-auto px-4 min-h-[800px]"
    >
        <!-- Sidebar -->
        <div class="hidden lg:block w-full h-full">
            <ProfileCard />
        </div>

        <!-- Main Content -->
        <div class="flex flex-col gap-8 min-w-0 h-full">
            <!-- Header -->
            <section
                class="relative overflow-hidden rounded-3xl bg-neutral-900 border border-white/10 p-8 md:p-10 text-center shrink-0"
            >
                <div
                    class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"
                >
                </div>
                <div class="relative z-10 max-w-2xl mx-auto space-y-4">
                    <h1
                        class="text-3xl md:text-4xl font-bold text-white leading-tight"
                    >
                        Test de <span class="text-gold">Salud SEO</span>: Eval√∫a
                        la visibilidad de tu negocio en Google
                    </h1>
                    <p class="text-base text-neutral-400 leading-relaxed">
                        Diagnostica tu sitio web en 2 minutos. Detecta errores
                        t√©cnicos, de contenido y autoridad.
                    </p>
                </div>
            </section>

            <!-- Quiz Container -->
            <div
                id="quiz-container"
                class="flex-grow bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-3xl p-6 md:p-10 shadow-2xl shadow-black/5 dark:shadow-black/20 flex flex-col justify-center relative overflow-hidden transition-all duration-500"
            >
                <!-- Progress Bar -->
                <div
                    id="progress-container"
                    class="absolute top-0 left-0 w-full h-2 bg-neutral-100 dark:bg-neutral-800 hidden"
                >
                    <div
                        id="progress-bar"
                        class="h-full bg-gold transition-all duration-500 ease-out w-0"
                    >
                    </div>
                </div>

                <!-- SCREEN 1: Intro -->
                <div
                    id="screen-intro"
                    class="text-center space-y-8 animate-fade-in"
                >
                    <div
                        class="w-24 h-24 bg-gold/10 rounded-full flex items-center justify-center mx-auto text-5xl"
                    >
                        ü©∫
                    </div>
                    <div class="space-y-4 max-w-lg mx-auto">
                        <h2
                            class="text-2xl font-bold text-neutral-900 dark:text-white"
                        >
                            ¬øTu web est√° lista para Google?
                        </h2>
                        <ul
                            class="text-left space-y-3 text-neutral-600 dark:text-neutral-400 bg-neutral-50 dark:bg-neutral-800/50 p-6 rounded-2xl"
                        >
                            <li class="flex items-center gap-3">
                                <span class="text-gold">‚úì</span> An√°lisis T√©cnico
                                (Velocidad, SSL)
                            </li>
                            <li class="flex items-center gap-3">
                                <span class="text-gold">‚úì</span> SEO On-Page (Contenido,
                                Estructura)
                            </li>
                            <li class="flex items-center gap-3">
                                <span class="text-gold">‚úì</span> Autoridad (Backlinks,
                                Conversi√≥n)
                            </li>
                        </ul>
                    </div>
                    <button
                        id="start-btn"
                        class="px-8 py-4 bg-gold text-black font-bold rounded-xl text-lg shadow-lg hover:shadow-gold/25 hover:scale-105 transition-all w-full md:w-auto"
                    >
                        Comenzar Diagn√≥stico Gratuito
                    </button>
                </div>

                <!-- SCREEN 2: Question -->
                <div
                    id="screen-question"
                    class="hidden flex-col items-center text-center space-y-8 max-w-2xl mx-auto w-full animate-fade-in"
                >
                    <span
                        id="question-category"
                        class="text-xs font-bold text-gold tracking-widest uppercase mb-2 block"
                    >
                        CATEGOR√çA A: SALUD T√âCNICA
                    </span>
                    <h3
                        id="question-title"
                        class="text-2xl md:text-3xl font-bold text-neutral-900 dark:text-white leading-snug"
                    >
                        ¬øTu sitio web carga en menos de 2 segundos?
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                        <button
                            class="answer-btn group p-6 rounded-xl border-2 border-neutral-200 dark:border-neutral-700 hover:border-gold dark:hover:border-gold hover:bg-gold/5 transition-all flex flex-col items-center gap-3"
                            data-value="yes"
                        >
                            <span class="text-3xl">üëç</span>
                            <span
                                class="font-bold text-neutral-900 dark:text-white"
                                >S√≠, es muy r√°pido</span
                            >
                        </button>
                        <button
                            class="answer-btn group p-6 rounded-xl border-2 border-neutral-200 dark:border-neutral-700 hover:border-red-400 hover:bg-red-500/5 transition-all flex flex-col items-center gap-3"
                            data-value="no"
                        >
                            <span class="text-3xl">üêå</span>
                            <span
                                class="font-bold text-neutral-900 dark:text-white"
                                >No / No estoy seguro</span
                            >
                        </button>
                    </div>

                    <div class="text-sm text-neutral-400">
                        Pregunta <span id="current-question-num">1</span> de <span
                            id="total-questions">9</span
                        >
                    </div>
                </div>

                <!-- SCREEN 3: Lead Capture -->
                <div
                    id="screen-lead"
                    class="hidden text-center space-y-8 max-w-lg mx-auto w-full animate-fade-in"
                >
                    <div
                        class="w-20 h-20 bg-gold/10 rounded-full flex items-center justify-center mx-auto text-4xl mb-6"
                    >
                        üéâ
                    </div>
                    <div>
                        <h2
                            class="text-2xl font-bold text-neutral-900 dark:text-white mb-2"
                        >
                            ¬°Analisis Completado!
                        </h2>
                        <p class="text-neutral-600 dark:text-neutral-400">
                            Hemos calculado tu puntaje de salud SEO. Ingresa tus
                            datos para ver el informe detallado y recibirlo en
                            tu correo.
                        </p>
                    </div>

                    <form id="lead-form" class="space-y-4 text-left">
                        <div>
                            <label
                                class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1"
                                >Nombre Completo</label
                            >
                            <input
                                type="text"
                                name="name"
                                required
                                class="w-full px-4 py-3 rounded-xl bg-neutral-50 dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700 focus:border-gold focus:ring-gold"
                                placeholder="Ej: Nicolas Cardenas"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1"
                                >Correo Electr√≥nico</label
                            >
                            <input
                                type="email"
                                name="email"
                                required
                                class="w-full px-4 py-3 rounded-xl bg-neutral-50 dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700 focus:border-gold focus:ring-gold"
                                placeholder="ejemplo@empresa.com"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1"
                                >URL del Sitio Web</label
                            >
                            <input
                                type="url"
                                name="website"
                                required
                                class="w-full px-4 py-3 rounded-xl bg-neutral-50 dark:bg-neutral-800 border-neutral-200 dark:border-neutral-700 focus:border-gold focus:ring-gold"
                                placeholder="https://tu-sitio.com"
                            />
                        </div>
                        <button
                            type="submit"
                            class="w-full py-4 bg-gold text-black font-bold rounded-xl shadow-lg hover:shadow-gold/25 hover:scale-[1.02] transition-all flex items-center justify-center gap-2"
                        >
                            <span>Ver Mis Resultados</span>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-5 w-5"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                                ><path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd"></path></svg
                            >
                        </button>
                    </form>
                </div>

                <!-- SCREEN 4: Results -->
                <div
                    id="screen-result"
                    class="hidden text-center space-y-8 animate-fade-in w-full"
                >
                    <!-- Score Circle -->
                    <div class="relative w-40 h-40 mx-auto">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle
                                cx="80"
                                cy="80"
                                r="70"
                                stroke="currentColor"
                                stroke-width="10"
                                fill="transparent"
                                class="text-neutral-200 dark:text-neutral-800"
                            ></circle>
                            <circle
                                id="score-circle"
                                cx="80"
                                cy="80"
                                r="70"
                                stroke="currentColor"
                                stroke-width="10"
                                fill="transparent"
                                class="text-gold transition-all duration-1000 ease-out"
                                stroke-dasharray="440"
                                stroke-dashoffset="440"></circle>
                        </svg>
                        <div
                            class="absolute inset-0 flex flex-col items-center justify-center"
                        >
                            <span
                                id="score-text"
                                class="text-4xl font-bold text-neutral-900 dark:text-white"
                                >0%</span
                            >
                            <span
                                class="text-xs font-bold uppercase text-neutral-500"
                                >Puntaje SEO</span
                            >
                        </div>
                    </div>

                    <div class="max-w-xl mx-auto space-y-4">
                        <div
                            id="result-badge"
                            class="inline-block px-4 py-1 rounded-full text-sm font-bold bg-neutral-100 dark:bg-neutral-800 text-neutral-600"
                        >
                            Analizando...
                        </div>
                        <h2
                            id="result-title"
                            class="text-2xl md:text-3xl font-bold text-neutral-900 dark:text-white"
                        >
                            <!-- Dynamic Title -->
                        </h2>
                        <p
                            id="result-desc"
                            class="text-neutral-600 dark:text-neutral-400 leading-relaxed"
                        >
                            <!-- Dynamic Desc -->
                        </p>
                    </div>

                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto"
                    >
                        <a
                            href="/cotizacion"
                            class="px-6 py-4 bg-neutral-900 dark:bg-white text-white dark:text-black font-bold rounded-xl shadow-lg hover:-translate-y-1 transition-all"
                        >
                            Solicitar Plan de Acci√≥n
                        </a>
                        <button
                            onclick="location.reload()"
                            class="px-6 py-4 border border-neutral-200 dark:border-neutral-700 text-neutral-600 dark:text-neutral-400 font-bold rounded-xl hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-all"
                        >
                            Repetir Test
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { submitForm } from "../../lib/submitForm";

    // --- Configuration ---
    const QUESTIONS = [
        // Category A: Technical (40 pts total)
        {
            category: "Salud T√©cnica",
            text: "¬øTu sitio web carga en menos de 2 segundos?",
            weight: 15,
        },
        {
            category: "Salud T√©cnica",
            text: "¬øTienes un certificado SSL activo (HTTPS)?",
            weight: 10,
        },
        {
            category: "Salud T√©cnica",
            text: "¬øTu sitio es 100% amigable con dispositivos m√≥viles?",
            weight: 15,
        },
        // Category B: On-Page (35 pts total)
        {
            category: "SEO On-Page",
            text: "¬øTienen todas tus p√°ginas t√≠tulos y meta descripciones √∫nicas?",
            weight: 10,
        },
        {
            category: "SEO On-Page",
            text: "¬øUtilizas una jerarqu√≠a clara de encabezados (H1, H2, H3)?",
            weight: 10,
        },
        {
            category: "SEO On-Page",
            text: "¬øTienes un blog que se actualiza al menos una vez al mes?",
            weight: 15,
        },
        // Category C: Authority (25 pts total)
        {
            category: "Autoridad y Conversi√≥n",
            text: "¬øTu negocio aparece en Google Maps (Perfil de Empresa)?",
            weight: 10,
        },
        {
            category: "Autoridad y Conversi√≥n",
            text: "¬øUtilizas datos estructurados (Schema Markup) para tus servicios?",
            weight: 10,
        },
        {
            category: "Autoridad y Conversi√≥n",
            text: "¬øTienes botones claros de llamada a la acci√≥n (WhatsApp, formularios)?",
            weight: 5,
        },
    ];

    // --- State ---
    let currentStep = 0; // 0=Intro, 1..N=Questions
    let score = 0;
    let answers = [];

    // --- DOM Elements ---
    let screenIntro, screenQuestion, screenLead, screenResult;
    let quizContainer, progressBar, progressContainer;

    document.addEventListener("astro:page-load", initQuiz);
    document.addEventListener("DOMContentLoaded", initQuiz);

    function initQuiz() {
        console.log("SEO Quiz Initialized");

        // Bind Elements
        screenIntro = document.getElementById("screen-intro");
        screenQuestion = document.getElementById("screen-question");
        screenLead = document.getElementById("screen-lead");
        screenResult = document.getElementById("screen-result");
        quizContainer = document.getElementById("quiz-container");
        progressContainer = document.getElementById("progress-container");
        progressBar = document.getElementById("progress-bar");

        if (!screenIntro) return;

        // Reset
        currentStep = 0;
        score = 0;
        answers = [];

        // Listeners
        document
            .getElementById("start-btn")
            ?.addEventListener("click", startQuiz);

        const answerBtns = document.querySelectorAll(".answer-btn");
        answerBtns.forEach((btn) => {
            // Clone to remove old listeners if re-init
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener("click", (e) => handleAnswer(e));
        });

        document
            .getElementById("lead-form")
            ?.addEventListener("submit", handleLeadSubmit);
    }

    function startQuiz() {
        showScreen(screenQuestion);
        progressContainer.classList.remove("hidden");
        updateQuestionUI(0);
    }

    function updateQuestionUI(index) {
        if (index >= QUESTIONS.length) {
            finishQuizQuestions();
            return;
        }

        const q = QUESTIONS[index];
        const titleEl = document.getElementById("question-title");
        const catEl = document.getElementById("question-category");
        const countEl = document.getElementById("current-question-num");
        const totalEl = document.getElementById("total-questions");

        // Fade out effect
        screenQuestion.classList.add("opacity-0", "translate-x-4");

        setTimeout(() => {
            titleEl.innerText = q.text;
            catEl.innerText = q.category.toUpperCase();
            countEl.innerText = index + 1;
            totalEl.innerText = QUESTIONS.length;

            screenQuestion.classList.remove("opacity-0", "translate-x-4");

            // Update Progress
            const pct = (index / QUESTIONS.length) * 100;
            progressBar.style.width = `${pct}%`;
        }, 300);
    }

    function handleAnswer(e) {
        const btn = e.currentTarget;
        const value = btn.getAttribute("data-value");
        const currentQ = QUESTIONS[currentStep];

        // Scoring
        if (value === "yes") {
            score += currentQ.weight;
        }

        answers.push({ question: currentQ.text, answer: value });
        currentStep++;
        updateQuestionUI(currentStep);
    }

    function finishQuizQuestions() {
        progressBar.style.width = "100%";
        showScreen(screenLead);
    }

    async function handleLeadSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        const submitBtn = e.target.querySelector("button[type='submit']");
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = "Guardando...";
        submitBtn.disabled = true;

        const data = {
            origen: "test-salud-seo",
            nombre: formData.get("name"),
            email: formData.get("email"),
            sitio_web: formData.get("website"),
            servicio: "Auditor√≠a SEO (Test)",
            detalles: {
                score: score,
                respuestas: answers,
            },
        };

        try {
            // const { submitForm } = await import("../../lib/submitForm"); // Removed in favor of static import

            const result = await submitForm(data);

            if (result.success) {
                showResults();
            } else {
                alert(
                    "Hubo un error al guardar tus resultados. Por favor intenta de nuevo.",
                );
            }
        } catch (error) {
            console.error(error);
            alert("Error de conexi√≥n.");
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    function showResults() {
        showScreen(screenResult);

        // Determine Status
        let title, desc, colorClass, badgeText;

        if (score <= 40) {
            title = "Estado Cr√≠tico";
            badgeText = "Requiere Atenci√≥n";
            desc =
                "Tu web es invisible para Google. Necesitas una intervenci√≥n t√©cnica urgente para solucionar bloqueos graves de rendimiento y accesibilidad.";
            colorClass = "text-red-500";
        } else if (score <= 75) {
            title = "Estado Promedio";
            badgeText = "Mejorable";
            desc =
                "Tienes las bases, pero est√°s perdiendo clientes frente a la competencia. Peque√±os ajustes t√©cnicos y de contenido podr√≠an duplicar tu tr√°fico.";
            colorClass = "text-yellow-500";
        } else {
            title = "Estado Optimizado";
            badgeText = "Excelente";
            desc =
                "¬°Excelente! Tu web est√° sana, pero siempre hay espacio para escalar. Considera estrategias avanzadas de autoridad y automatizaci√≥n.";
            colorClass = "text-green-500";
        }

        document.getElementById("result-title").innerText = title;
        document.getElementById("result-desc").innerText = desc;
        document.getElementById("result-badge").innerText = badgeText;

        // Animate Score
        const circle = document.getElementById("score-circle");
        const text = document.getElementById("score-text");

        // Stroke Dasharray logic
        // r=70, C = 2 * pi * 70 ‚âà 440
        const circumference = 440;
        const offset = circumference - (score / 100) * circumference;

        setTimeout(() => {
            circle.style.strokeDashoffset = offset;

            // Color update
            if (score <= 40) circle.classList.add("text-red-500");
            else if (score <= 75) circle.classList.add("text-yellow-500");
            else circle.classList.add("text-green-500");

            // Number count up
            let start = 0;
            const duration = 1500;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // Ease out cubic
                const ease = 1 - Math.pow(1 - progress, 3);

                const currentVal = Math.floor(ease * score);
                text.innerText = `${currentVal}%`;

                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }, 500);
    }

    function showScreen(screen) {
        [screenIntro, screenQuestion, screenLead, screenResult].forEach((s) =>
            s.classList.add("hidden"),
        );
        screen.classList.remove("hidden");
    }
</script>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .animate-fade-in {
        animation: fadeIn 0.5s ease-out forwards;
    }
</style>

<script>
    // Dynamic Title Logic
    const originalTitle = document.title;
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            document.title = "üõë ¬°Tu web necesita un chequeo!";
        } else {
            document.title = originalTitle;
        }
    });
</script>
